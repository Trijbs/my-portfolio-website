<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: #111111;
            border-right: 1px solid #333;
            padding: 20px;
        }

        .sidebar h2 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: 10px;
        }

        .sidebar a {
            color: #ccc;
            text-decoration: none;
            padding: 8px 12px;
            display: block;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: #00ff88;
            color: #000;
        }

        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            color: #00ff88;
            font-size: 28px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #111111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #00ff88;
            transform: translateY(-2px);
        }

        .stat-card h3 {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 12px;
            color: #888;
        }

        .chart-container {
            background: #111111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            color: #fff;
            font-size: 18px;
        }

        .time-filter {
            display: flex;
            gap: 10px;
        }

        .time-filter button {
            background: #222;
            border: 1px solid #444;
            color: #ccc;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-filter button:hover,
        .time-filter button.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        .chart {
            height: 300px;
            background: #0a0a0a;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .heatmap-container {
            position: relative;
            background: #0a0a0a;
            border-radius: 8px;
            height: 400px;
            overflow: hidden;
        }

        .heatmap-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(0, 255, 136, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0); }
            to { opacity: 0.6; transform: scale(1); }
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            background: #0a0a0a;
            border-left: 3px solid #00ff88;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .event-item .event-type {
            color: #00ff88;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        .event-item .event-time {
            color: #888;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .event-item .event-data {
            color: #ccc;
            font-size: 13px;
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .control-btn {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
        }

        .modal-content {
            background: #111;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 12px;
            border: 1px solid #333;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .close {
            color: #ccc;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #00ff88;
        }

        .json-viewer {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <h2>Analytics</h2>
            <ul>
                <li><a href="#overview" class="nav-link active">Overview</a></li>
                <li><a href="#realtime" class="nav-link">Real-time</a></li>
                <li><a href="#heatmap" class="nav-link">Heatmap</a></li>
                <li><a href="#events" class="nav-link">Events</a></li>
                <li><a href="#performance" class="nav-link">Performance</a></li>
                <li><a href="#users" class="nav-link">Users</a></li>
                <li><a href="#devices" class="nav-link">Devices</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Live Analytics Dashboard</h1>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Live Tracking Active</span>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" onclick="exportData()">Export Data</button>
                <button class="control-btn" onclick="clearData()">Clear Data</button>
                <button class="control-btn" onclick="toggleTracking()">Toggle Tracking</button>
            </div>

            <!-- Overview Section -->
            <div id="overview" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Active Sessions</h3>
                        <div class="value" id="active-sessions">0</div>
                        <div class="change">+0% from last hour</div>
                    </div>
                    <div class="stat-card">
                        <h3>Page Views</h3>
                        <div class="value" id="page-views">0</div>
                        <div class="change">+0% from yesterday</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Events</h3>
                        <div class="value" id="total-events">0</div>
                        <div class="change">Real-time</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg. Session Duration</h3>
                        <div class="value" id="avg-duration">0s</div>
                        <div class="change">+0% from last week</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Events Over Time</h3>
                        <div class="time-filter">
                            <button class="active" onclick="setTimeFilter('1h')">1H</button>
                            <button onclick="setTimeFilter('6h')">6H</button>
                            <button onclick="setTimeFilter('24h')">24H</button>
                            <button onclick="setTimeFilter('7d')">7D</button>
                        </div>
                    </div>
                    <div class="chart" id="events-chart">
                        <canvas id="events-canvas" width="800" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Real-time Section -->
            <div id="realtime" class="section" style="display: none;">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Live Events Stream</h3>
                    </div>
                    <div class="events-list" id="live-events"></div>
                </div>
            </div>

            <!-- Heatmap Section -->
            <div id="heatmap" class="section" style="display: none;">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Click Heatmap</h3>
                        <button onclick="clearHeatmap()">Clear Heatmap</button>
                    </div>
                    <div class="heatmap-container" id="heatmap-container"></div>
                </div>
            </div>

            <!-- Events Section -->
            <div id="events" class="section" style="display: none;">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Event History</h3>
                        <input type="text" id="event-search" placeholder="Search events..." style="background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px;">
                    </div>
                    <div class="events-list" id="events-history"></div>
                </div>
            </div>

            <!-- Performance Section -->
            <div id="performance" class="section" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Page Load Time</h3>
                        <div class="value" id="load-time">0ms</div>
                        <div class="change">Average</div>
                    </div>
                    <div class="stat-card">
                        <h3>DOM Ready</h3>
                        <div class="value" id="dom-ready">0ms</div>
                        <div class="change">Time to interactive</div>
                    </div>
                    <div class="stat-card">
                        <h3>Resources Loaded</h3>
                        <div class="value" id="resources-loaded">0</div>
                        <div class="change">Total count</div>
                    </div>
                    <div class="stat-card">
                        <h3>Errors</h3>
                        <div class="value" id="error-count">0</div>
                        <div class="change">JavaScript errors</div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="section" style="display: none;">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>User Sessions</h3>
                    </div>
                    <div id="users-list"></div>
                </div>
            </div>

            <!-- Devices Section -->
            <div id="devices" class="section" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Desktop</h3>
                        <div class="value" id="desktop-users">0</div>
                        <div class="change">Users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Mobile</h3>
                        <div class="value" id="mobile-users">0</div>
                        <div class="change">Users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Tablet</h3>
                        <div class="value" id="tablet-users">0</div>
                        <div class="change">Users</div>
                    </div>
                    <div class="stat-card">
                        <h3>Screen Resolution</h3>
                        <div class="value" id="avg-resolution">0x0</div>
                        <div class="change">Most common</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed views -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Event Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        class AnalyticsDashboard {
            constructor() {
                this.events = [];
                this.sessions = new Map();
                this.currentTimeFilter = '1h';
                this.isTracking = true;
                
                this.init();
            }

            init() {
                this.setupNavigation();
                this.loadStoredData();
                this.startRealTimeUpdates();
                this.setupEventListeners();
                this.updateDashboard();
            }

            setupNavigation() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.target.getAttribute('href').substring(1);
                        this.showSection(target);
                        
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        e.target.classList.add('active');
                    });
                });
            }

            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById(sectionId).style.display = 'block';
                
                // Update section-specific data
                switch(sectionId) {
                    case 'heatmap':
                        this.updateHeatmap();
                        break;
                    case 'events':
                        this.updateEventsHistory();
                        break;
                    case 'performance':
                        this.updatePerformanceMetrics();
                        break;
                    case 'users':
                        this.updateUsersData();
                        break;
                    case 'devices':
                        this.updateDevicesData();
                        break;
                }
            }

            loadStoredData() {
                const storedEvents = localStorage.getItem('analytics_events');
                if (storedEvents) {
                    this.events = JSON.parse(storedEvents);
                }
            }

            startRealTimeUpdates() {
                // Check for new events every second
                setInterval(() => {
                    this.loadStoredData();
                    this.updateDashboard();
                    this.updateLiveEvents();
                }, 1000);
            }

            setupEventListeners() {
                // Event search
                document.getElementById('event-search').addEventListener('input', (e) => {
                    this.filterEvents(e.target.value);
                });
            }

            updateDashboard() {
                this.updateOverviewStats();
                this.updateEventsChart();
            }

            updateOverviewStats() {
                const now = Date.now();
                const oneHour = 60 * 60 * 1000;
                const oneDay = 24 * oneHour;

                // Active sessions (sessions with events in last hour)
                const recentEvents = this.events.filter(e => now - e.timestamp < oneHour);
                const activeSessions = new Set(recentEvents.map(e => e.sessionId)).size;
                document.getElementById('active-sessions').textContent = activeSessions;

                // Page views
                const pageViews = this.events.filter(e => e.eventType === 'page_load').length;
                document.getElementById('page-views').textContent = pageViews;

                // Total events
                document.getElementById('total-events').textContent = this.events.length;

                // Average session duration
                const sessions = this.groupEventsBySession();
                let totalDuration = 0;
                let sessionCount = 0;

                sessions.forEach(sessionEvents => {
                    if (sessionEvents.length > 1) {
                        const duration = Math.max(...sessionEvents.map(e => e.timestamp)) - 
                                       Math.min(...sessionEvents.map(e => e.timestamp));
                        totalDuration += duration;
                        sessionCount++;
                    }
                });

                const avgDuration = sessionCount > 0 ? Math.round(totalDuration / sessionCount / 1000) : 0;
                document.getElementById('avg-duration').textContent = avgDuration + 's';
            }

            updateEventsChart() {
                const canvas = document.getElementById('events-canvas');
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Get time range
                const now = Date.now();
                const timeRange = this.getTimeRange(this.currentTimeFilter);
                const startTime = now - timeRange;
                
                // Filter events by time range
                const filteredEvents = this.events.filter(e => e.timestamp >= startTime);
                
                // Group events by time intervals
                const intervals = 20; // Number of intervals to show
                const intervalSize = timeRange / intervals;
                const eventCounts = new Array(intervals).fill(0);
                
                filteredEvents.forEach(event => {
                    const intervalIndex = Math.floor((event.timestamp - startTime) / intervalSize);
                    if (intervalIndex >= 0 && intervalIndex < intervals) {
                        eventCounts[intervalIndex]++;
                    }
                });
                
                // Draw chart
                const maxCount = Math.max(...eventCounts, 1);
                const barWidth = canvas.width / intervals;
                const barMaxHeight = canvas.height - 40;
                
                ctx.fillStyle = '#00ff88';
                eventCounts.forEach((count, index) => {
                    const barHeight = (count / maxCount) * barMaxHeight;
                    const x = index * barWidth;
                    const y = canvas.height - barHeight - 20;
                    
                    ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                });
                
                // Draw labels
                ctx.fillStyle = '#ccc';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                
                for (let i = 0; i < intervals; i += 4) {
                    const time = new Date(startTime + (i * intervalSize));
                    const label = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    ctx.fillText(label, i * barWidth + barWidth/2, canvas.height - 5);
                }
            }

            updateLiveEvents() {
                const liveEventsContainer = document.getElementById('live-events');
                const recentEvents = this.events.slice(-20).reverse(); // Last 20 events
                
                liveEventsContainer.innerHTML = '';
                
                recentEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    eventElement.innerHTML = `
                        <div class="event-type">${event.eventType}</div>
                        <div class="event-time">${new Date(event.timestamp).toLocaleTimeString()}</div>
                        <div class="event-data">${this.formatEventData(event)}</div>
                    `;
                    eventElement.addEventListener('click', () => this.showEventDetails(event));
                    liveEventsContainer.appendChild(eventElement);
                });
            }

            updateHeatmap() {
                const container = document.getElementById('heatmap-container');
                container.innerHTML = '';
                
                const clickEvents = this.events.filter(e => e.eventType === 'click');
                
                clickEvents.forEach(event => {
                    if (event.x && event.y) {
                        const point = document.createElement('div');
                        point.className = 'heatmap-point';
                        point.style.left = (event.x / window.innerWidth * 100) + '%';
                        point.style.top = (event.y / window.innerHeight * 100) + '%';
                        container.appendChild(point);
                    }
                });
            }

            updateEventsHistory() {
                const container = document.getElementById('events-history');
                container.innerHTML = '';
                
                this.events.slice().reverse().forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'event-item';
                    eventElement.innerHTML = `
                        <div class="event-type">${event.eventType}</div>
                        <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
                        <div class="event-data">${this.formatEventData(event)}</div>
                    `;
                    eventElement.addEventListener('click', () => this.showEventDetails(event));
                    container.appendChild(eventElement);
                });
            }

            updatePerformanceMetrics() {
                const performanceEvents = this.events.filter(e => e.eventType === 'performance_timing');
                const errorEvents = this.events.filter(e => e.eventType === 'javascript_error');
                const resourceEvents = this.events.filter(e => e.eventType === 'resource_load');
                
                if (performanceEvents.length > 0) {
                    const latest = performanceEvents[performanceEvents.length - 1];
                    document.getElementById('load-time').textContent = latest.loadEventEnd + 'ms';
                    document.getElementById('dom-ready').textContent = latest.domContentLoadedEventEnd + 'ms';
                }
                
                document.getElementById('resources-loaded').textContent = resourceEvents.length;
                document.getElementById('error-count').textContent = errorEvents.length;
            }

            updateUsersData() {
                const container = document.getElementById('users-list');
                const sessions = this.groupEventsBySession();
                
                container.innerHTML = '';
                
                sessions.forEach((events, sessionId) => {
                    const firstEvent = events[0];
                    const lastEvent = events[events.length - 1];
                    const duration = lastEvent.timestamp - firstEvent.timestamp;
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'event-item';
                    userElement.innerHTML = `
                        <div class="event-type">Session: ${sessionId.substring(0, 8)}...</div>
                        <div class="event-time">Duration: ${Math.round(duration / 1000)}s</div>
                        <div class="event-data">Events: ${events.length} | User: ${firstEvent.userId?.substring(0, 8)}...</div>
                    `;
                    container.appendChild(userElement);
                });
            }

            updateDevicesData() {
                const deviceEvents = this.events.filter(e => e.deviceInfo);
                
                if (deviceEvents.length === 0) return;
                
                let desktop = 0, mobile = 0, tablet = 0;
                const resolutions = {};
                
                deviceEvents.forEach(event => {
                    const width = event.deviceInfo.windowWidth;
                    
                    if (width >= 1024) desktop++;
                    else if (width >= 768) tablet++;
                    else mobile++;
                    
                    const resolution = `${event.deviceInfo.screenWidth}x${event.deviceInfo.screenHeight}`;
                    resolutions[resolution] = (resolutions[resolution] || 0) + 1;
                });
                
                document.getElementById('desktop-users').textContent = desktop;
                document.getElementById('mobile-users').textContent = mobile;
                document.getElementById('tablet-users').textContent = tablet;
                
                // Most common resolution
                const mostCommon = Object.keys(resolutions).reduce((a, b) => 
                    resolutions[a] > resolutions[b] ? a : b, '0x0');
                document.getElementById('avg-resolution').textContent = mostCommon;
            }

            groupEventsBySession() {
                const sessions = new Map();
                
                this.events.forEach(event => {
                    if (!sessions.has(event.sessionId)) {
                        sessions.set(event.sessionId, []);
                    }
                    sessions.get(event.sessionId).push(event);
                });
                
                return sessions;
            }

            formatEventData(event) {
                const data = { ...event };
                delete data.id;
                delete data.sessionId;
                delete data.userId;
                delete data.timestamp;
                delete data.eventType;
                delete data.url;
                delete data.referrer;
                
                const keys = Object.keys(data);
                if (keys.length === 0) return 'No additional data';
                
                return keys.slice(0, 3).map(key => `${key}: ${JSON.stringify(data[key])}`).join(', ');
            }

            showEventDetails(event) {
                document.getElementById('modal-title').textContent = `Event: ${event.eventType}`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="json-viewer">${JSON.stringify(event, null, 2)}</div>
                `;
                document.getElementById('detail-modal').style.display = 'block';
            }

            getTimeRange(filter) {
                const hour = 60 * 60 * 1000;
                switch(filter) {
                    case '1h': return hour;
                    case '6h': return 6 * hour;
                    case '24h': return 24 * hour;
                    case '7d': return 7 * 24 * hour;
                    default: return hour;
                }
            }

            filterEvents(searchTerm) {
                const container = document.getElementById('events-history');
                const events = container.querySelectorAll('.event-item');
                
                events.forEach(event => {
                    const text = event.textContent.toLowerCase();
                    event.style.display = text.includes(searchTerm.toLowerCase()) ? 'block' : 'none';
                });
            }
        }

        // Global functions
        function setTimeFilter(filter) {
            dashboard.currentTimeFilter = filter;
            document.querySelectorAll('.time-filter button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            dashboard.updateEventsChart();
        }

        function exportData() {
            if (window.analytics) {
                window.analytics.exportData();
            }
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all analytics data?')) {
                localStorage.removeItem('analytics_events');
                localStorage.removeItem('analytics_user_id');
                dashboard.events = [];
                dashboard.updateDashboard();
            }
        }

        function toggleTracking() {
            if (window.analytics) {
                if (dashboard.isTracking) {
                    window.analytics.stopTracking();
                    dashboard.isTracking = false;
                } else {
                    window.analytics.startTracking();
                    dashboard.isTracking = true;
                }
            }
        }

        function clearHeatmap() {
            document.getElementById('heatmap-container').innerHTML = '';
        }

        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }

        // Initialize dashboard
        const dashboard = new AnalyticsDashboard();

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>